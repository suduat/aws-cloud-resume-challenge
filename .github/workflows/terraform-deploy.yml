name: Terraform CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'infra/**'
  workflow_dispatch:

jobs:
  terraform:
    name: 'Deploy Infrastructure'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::447572331640:role/GitHubActionsTerraformRole
        aws-region: ap-south-1

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_wrapper: false

    - name: Terraform Init
      working-directory: infra
      run: terraform init -upgrade

    - name: Terraform Validate
      working-directory: infra
      run: terraform validate

    - name: Terraform Plan
      working-directory: infra
      run: terraform plan

    - name: Terraform Apply
      working-directory: infra
      run: terraform apply -auto-approve

    - name: Wait for CloudFront Deployment
      working-directory: infra
      run: |
        DIST_ID=$(terraform output -raw cloudfront_distribution_id)
        echo "â³ Waiting for CloudFront..."
        aws cloudfront wait distribution-deployed --id $DIST_ID
        echo "âœ… CloudFront ready"

    - name: Generate config.js and Upload Files
      id: upload
      working-directory: infra
      run: |
        LAMBDA_URL=$(terraform output -raw lambda_function_url)
        S3_BUCKET=$(terraform output -raw s3_bucket_name)
        DIST_ID=$(terraform output -raw cloudfront_distribution_id)
        
        # Generate config.js
        cat > ../html5up-strata/assets/js/config.js << EOF
        const CONFIG = {
          LAMBDA_URL: "${LAMBDA_URL}"
        };
        EOF
        
        # Upload to S3
        cd ..
        aws s3 sync html5up-strata/ s3://$S3_BUCKET/ --delete
        
        # Invalidate cache
        aws cloudfront create-invalidation --distribution-id $DIST_ID --paths "/*"
        
        echo "lambda_url=$LAMBDA_URL" >> $GITHUB_OUTPUT
        echo "âœ… Files uploaded and cache invalidated"

    - name: Wait and Quick Validation
      run: |
        echo "â³ Waiting 2 minutes for propagation..."
        sleep 120
        
        echo "ğŸ§ª Quick validation..."
        
        # Test website
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://sudeshna.resume.animals4life.shop)
        if [ "$STATUS" = "200" ]; then
          echo "âœ… Website accessible"
        else
          echo "âŒ Website error: $STATUS"
          exit 1
        fi
        
        # Test Lambda
        LAMBDA_URL="${{ steps.upload.outputs.lambda_url }}"
        if curl -s $LAMBDA_URL | grep -q "views"; then
          VIEWS=$(curl -s $LAMBDA_URL | grep -o '"views":[0-9]*' | grep -o '[0-9]*')
          echo "âœ… Lambda working (Views: $VIEWS)"
        else
          echo "âŒ Lambda failed"
          exit 1
        fi
        
        echo "âœ… Basic validation passed"

    - name: Deployment Summary
      run: |
        echo ""
        echo "ğŸ‰ Deployment Complete!"
        echo "========================================"
        echo "ğŸ“ Website: https://sudeshna.resume.animals4life.shop"
        echo "âš¡ Lambda: ${{ steps.upload.outputs.lambda_url }}"
        echo ""
        echo "ğŸ’¡ Run full tests: Actions â†’ ğŸ§ª Run Tests & Validation"
        echo "========================================"
