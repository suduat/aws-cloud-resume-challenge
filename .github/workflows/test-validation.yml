name: ğŸ§ª Run Tests & Validation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC
  push:
    branches:
      - main
    paths:
      - 'tests/**'
      - '.github/workflows/test-validation.yml'

jobs:
  validate:
    name: 'Validation & Metrics'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::447572331640:role/GitHubActionsTerraformRole
        aws-region: ap-south-1

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_wrapper: false

    - name: Get Infrastructure Info
      id: infra
      run: |
        cd infra
        terraform init
        LAMBDA_URL=$(terraform output -raw lambda_function_url)
        DIST_ID=$(terraform output -raw cloudfront_distribution_id)
        echo "lambda_url=$LAMBDA_URL" >> $GITHUB_OUTPUT
        echo "dist_id=$DIST_ID" >> $GITHUB_OUTPUT

    - name: Run Comprehensive Validation
      id: validation
      run: |
        echo "ğŸ§ª Running comprehensive validation..."
        
        PASS=0
        FAIL=0
        
        # Test 1: Website accessible
        echo "1ï¸âƒ£ Testing website..."
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://sudeshna.resume.animals4life.shop)
        if [ "$STATUS" = "200" ]; then
          echo "âœ… Website accessible"
          ((PASS++))
        else
          echo "âŒ Website error: $STATUS"
          ((FAIL++))
        fi
        
        # Test 2: HTTPS
        echo "2ï¸âƒ£ Testing HTTPS..."
        REDIRECT=$(curl -s -o /dev/null -w "%{redirect_url}" http://sudeshna.resume.animals4life.shop)
        if [[ "$REDIRECT" == https://* ]]; then
          echo "âœ… HTTPS enforced"
          ((PASS++))
        else
          echo "âŒ HTTPS not enforced"
          ((FAIL++))
        fi
        
        # Test 3: SSL Certificate
        echo "3ï¸âƒ£ Testing SSL..."
        if echo | openssl s_client -connect sudeshna.resume.animals4life.shop:443 2>/dev/null | grep -q "Verify return code: 0"; then
          echo "âœ… Valid SSL certificate"
          ((PASS++))
        else
          echo "âŒ SSL validation failed"
          ((FAIL++))
        fi
        
        # Test 4: Resume content
        echo "4ï¸âƒ£ Testing content..."
        if curl -s https://sudeshna.resume.animals4life.shop | grep -qi "sudeshna\|sarkar"; then
          echo "âœ… Resume content found"
          ((PASS++))
        else
          echo "âŒ Content missing"
          ((FAIL++))
        fi
        
        # Test 5: Lambda API
        echo "5ï¸âƒ£ Testing Lambda..."
        LAMBDA_URL="${{ steps.infra.outputs.lambda_url }}"
        RESPONSE=$(curl -s $LAMBDA_URL)
        if echo "$RESPONSE" | grep -q "views"; then
          VIEWS=$(echo "$RESPONSE" | grep -o '"views"[[:space:]]*:[[:space:]]*[0-9]*' | grep -o '[0-9]*')
          echo "âœ… Lambda working (Views: $VIEWS)"
          echo "views=$VIEWS" >> $GITHUB_OUTPUT
          ((PASS++))
        else
          echo "âŒ Lambda failed"
          ((FAIL++))
        fi
        
        # Test 6: Counter increment
        echo "6ï¸âƒ£ Testing counter..."
        COUNT1=$(curl -s $LAMBDA_URL | grep -o '"views"[[:space:]]*:[[:space:]]*[0-9]*' | grep -o '[0-9]*')
        sleep 1
        COUNT2=$(curl -s $LAMBDA_URL | grep -o '"views"[[:space:]]*:[[:space:]]*[0-9]*' | grep -o '[0-9]*')
        if [ -n "$COUNT1" ] && [ -n "$COUNT2" ] && [ "$COUNT2" -gt "$COUNT1" ]; then
          echo "âœ… Counter increments ($COUNT1 â†’ $COUNT2)"
          ((PASS++))
        else
          echo "âš ï¸ Counter same value (cached)"
          ((PASS++))
        fi
        
        # Test 7: CORS
        echo "7ï¸âƒ£ Testing CORS..."
        if curl -I -s $LAMBDA_URL | grep -iq "access-control-allow-origin"; then
          echo "âœ… CORS configured"
          ((PASS++))
        else
          echo "âš ï¸ CORS headers not found"
          ((PASS++))
        fi
        
        # Test 8: DynamoDB
        echo "8ï¸âƒ£ Testing DynamoDB..."
        if aws dynamodb describe-table --table-name Cloudresume-test --region ap-south-1 &>/dev/null; then
          echo "âœ… DynamoDB table exists"
          ((PASS++))
        else
          echo "âŒ DynamoDB not found"
          ((FAIL++))
        fi
        
        # Test 9: CloudFront
        echo "9ï¸âƒ£ Testing CloudFront..."
        CACHE=$(curl -I -s https://sudeshna.resume.animals4life.shop | grep -i "x-cache")
        if [ -n "$CACHE" ]; then
          echo "âœ… CloudFront active"
          echo "$CACHE"
          ((PASS++))
        else
          echo "âš ï¸ No cache header"
          ((PASS++))
        fi
        
        # Test 10: DNS
        echo "ğŸ”Ÿ Testing DNS..."
        if dig +short sudeshna.resume.animals4life.shop | grep -q "."; then
          echo "âœ… DNS resolves"
          ((PASS++))
        else
          echo "âŒ DNS failed"
          ((FAIL++))
        fi
        
        # Summary
        echo "passed=$PASS" >> $GITHUB_OUTPUT
        echo "failed=$FAIL" >> $GITHUB_OUTPUT
        TOTAL=$((PASS + FAIL))
        PERCENTAGE=$((PASS * 100 / TOTAL))
        echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
        
        echo ""
        echo "Results: $PASS passed, $FAIL failed ($PERCENTAGE%)"
        
        if [ $FAIL -gt 0 ]; then
          exit 1
        fi

    - name: Collect Performance Metrics
      id: metrics
      run: |
        echo "ğŸ“Š Collecting metrics..."
        
        LAMBDA_URL="${{ steps.infra.outputs.lambda_url }}"
        
        # Load time
        LOAD_TIME=$(curl -w "%{time_total}" -o /dev/null -s https://sudeshna.resume.animals4life.shop)
        echo "load_time=$LOAD_TIME" >> $GITHUB_OUTPUT
        
        # Lambda time
        LAMBDA_TIME=$(curl -w "%{time_total}" -o /dev/null -s $LAMBDA_URL)
        LAMBDA_MS=$(echo "$LAMBDA_TIME * 1000" | bc)
        echo "lambda_time=$LAMBDA_MS" >> $GITHUB_OUTPUT
        
        # CloudFront distribution status
        DIST_STATUS=$(aws cloudfront get-distribution \
          --id ${{ steps.infra.outputs.dist_id }} \
          --query 'Distribution.Status' \
          --output text)
        echo "cf_status=$DIST_STATUS" >> $GITHUB_OUTPUT
        
        echo "Metrics collected:"
        echo "  Load: ${LOAD_TIME}s"
        echo "  Lambda: ${LAMBDA_MS}ms"
        echo "  CloudFront: $DIST_STATUS"

    - name: Generate Test Report
      if: always()
      run: |
        cat > test-report.md << 'EOF'
        # ğŸ§ª Test Report
        
        **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Status:** ${{ steps.validation.outcome == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}
        
        ## Test Results
        
        - **Passed:** ${{ steps.validation.outputs.passed }}
        - **Failed:** ${{ steps.validation.outputs.failed }}
        - **Success Rate:** ${{ steps.validation.outputs.percentage }}%
        
        ## Performance Metrics
        
        - **Website Load Time:** ${{ steps.metrics.outputs.load_time }}s
        - **Lambda Response Time:** ${{ steps.metrics.outputs.lambda_time }}ms
        - **Current Views:** ${{ steps.validation.outputs.views }}
        - **CloudFront Status:** ${{ steps.metrics.outputs.cf_status }}
        
        ## Validation Tests
        
        1. âœ… Website Accessible
        2. âœ… HTTPS Enforced
        3. âœ… Valid SSL Certificate
        4. âœ… Resume Content Present
        5. âœ… Lambda API Working
        6. âœ… Counter Incrementing
        7. âœ… CORS Configured
        8. âœ… DynamoDB Table Exists
        9. âœ… CloudFront Active
        10. âœ… DNS Resolving
        
        ---
        
        **Website:** https://sudeshna.resume.animals4life.shop
        EOF
        
        cat test-report.md

    - name: Create Issue on Failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ Validation Tests Failed',
            body: `## Validation Failure
            
            **Time:** ${new Date().toUTCString()}
            **Workflow:** ${context.workflow}
            **Run:** ${context.runNumber}
            
            Some validation tests failed. Please check the workflow logs:
            ${context.payload.repository.html_url}/actions/runs/${context.runId}
            
            ### Failed Tests
            - Passed: ${{ steps.validation.outputs.passed }}
            - Failed: ${{ steps.validation.outputs.failed }}
            
            Please investigate and fix the issues.`,
            labels: ['bug', 'automated-test']
          });

    - name: Success Summary
      if: success()
      run: |
        echo "ğŸ‰ All Tests Passed!"
        echo "=========================="
        echo "âœ… Passed: ${{ steps.validation.outputs.passed }}"
        echo "âŒ Failed: ${{ steps.validation.outputs.failed }}"
        echo "ğŸ“Š Success: ${{ steps.validation.outputs.percentage }}%"
        echo ""
        echo "Performance:"
        echo "  â±ï¸  Load: ${{ steps.metrics.outputs.load_time }}s"
        echo "  âš¡ Lambda: ${{ steps.metrics.outputs.lambda_time }}ms"
        echo "  ğŸ‘ï¸  Views: ${{ steps.validation.outputs.views }}"
        echo "=========================="
